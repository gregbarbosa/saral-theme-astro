---
import { type CollectionEntry, getCollection } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import FormattedDate from '../../components/FormattedDate.astro'
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'
import noThumbnail from '../../assets/no-thumbnail.jpg'

export async function getStaticPaths() {
	const freebies = await getCollection('freebies')
	return freebies.map((freebie) => ({
		params: { slug: freebie.slug },
		props: freebie,
	}))
}

type Props = CollectionEntry<'freebies'>

const freebie = Astro.props
const { Content } = await freebie.render()

const freebieImages = import.meta.glob<{ default: ImageMetadata }>(
	'/src/assets/freebies/**/*.{jpeg,jpg,png,gif,webp}'
)

const coverImageKey = Object.keys(freebieImages).find((path) =>
	path.includes(`/freebies/${freebie.slug}/cover.`)
)
---

<BaseLayout title={freebie.data.title} description={freebie.data.description}>
	<main id="main-content" class="app-container py-24">
		<div class="max-w-3xl mx-auto">
			<h1 class="text-4xl font-bold mb-4">{freebie.data.title}</h1>

			<p class="text-lg text-muted-foreground mb-8">
				<FormattedDate date={freebie.data.pubDate} />
			</p>

			{
				coverImageKey && freebieImages[coverImageKey] ? (
					<Image
						src={freebieImages[coverImageKey]()}
						alt={freebie.data.title}
						class="rounded-xl mb-8 w-full"
						loading="eager"
					/>
				) : (
					<Image
						src={noThumbnail}
						alt={freebie.data.title}
						class="rounded-xl mb-8 w-full"
						loading="eager"
					/>
				)
			}

			<div
				class="prose prose-neutral prose-lg md:prose-xl dark:prose-invert prose-img:rounded-xl mb-12"
			>
				<Content />
			</div>

			<div class="mt-12 p-8 bg-muted/50 rounded-2xl text-center">
				<h2 class="text-2xl font-semibold mb-4">Download This Freebie</h2>
				<p class="text-muted-foreground mb-6 max-w-lg mx-auto">
					Click the button below to download this free resource.
				</p>
				<a
					href={freebie.data.downloadUrl}
					download
					class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-11 px-8"
				>
					Download Now
				</a>
			</div>
		</div>
	</main>
</BaseLayout>
